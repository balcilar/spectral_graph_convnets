clear all
clc


[imgDataTrain, labelsTrain, imgDataTest, labelsTest] = prepareData;

%W=createGridGraph(28);
A=gridgrqph(28,8);
level=4;

[G, parents]= Coarsen(A,level);

% calculate basis
for i=1:level+1    
    D = diag(1./sqrt(sum(G{i},1)));    
    L{i}= eye(size(D,1)) - D * G{i} * D;    
    [u, v]=eig(full(L{i}));
    v=diag(v);
    lmax(i)=max(v);
    
    % normalized laplacian make max eigenvalue 1
    L{i}= L{i}/lmax(i) * 2 - eye(size(D,1));
    
end



% take first 100 element as batch
bsize=20;
K=25;
nfo=32;

x=double(imgDataTrain(:,:,1,1:bsize));
x=reshape(x,size(x,1)*size(x,2),size(x,3),size(x,4));
x(:,2,:)=255-x(:,1,:);
[n, f, b]=size(x);


yx=reshape(x,[n f*b]);
x0=yx;

x1=L{1}*x0;
yx(:,:,2)=x1;
for i=3:K
    x2 = 2 * (L{1}*x1) - x0;  
    yx(:,:,i)=x2;
    x0=x1;
    x1=x2;
end
nf=size(x,2);
yx=reshape(yx,n,f,b,K);
yx=permute(yx,[1 3 2 4]);
yx=reshape(yx,n,b, f*K);
yx=reshape(yx,n*b, f*K);

W=randn(K*f,nfo);
b=randn(1,nfo);

y=yx*W+b;
            







